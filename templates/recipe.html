<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ recipe.title }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .recipe-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
        }
        .recipe-header {
            padding: 40px;
            text-align: center;
        }
        .recipe-header h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .recipe-header p {
            font-size: 1.2rem;
            color: #666;
        }
        .nutrition-facts {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .fact {
            text-align: center;
        }
        .fact-value {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .fact-label {
            font-size: 0.9rem;
            color: #666;
        }
        .recipe-body {
            padding: 0 40px 40px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 40px;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .ingredients-list, .steps-list {
            list-style: none;
            padding-left: 0;
        }
        .ingredients-list li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 1.1rem;
        }
        .steps-list li {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            display: flex;
        }
        .step-number {
            font-weight: 600;
            margin-right: 15px;
            color: #667eea;
        }
        .back-link {
            display: inline-block;
            margin: 20px 0 0 40px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }
        .edit-btn {
            display: inline-block;
            margin: 20px 0 0 20px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .edit-btn:hover {
            background: #218838;
        }
        .save-btn {
            display: inline-block;
            margin: 20px 0 0 20px;
            padding: 10px 20px;
            background: #ff6b6b;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .save-btn:hover {
            background: #ee5a24;
        }
        .cancel-btn {
            display: inline-block;
            margin: 20px 0 0 20px;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .cancel-btn:hover {
            background: #5a6268;
        }
        .edit-mode {
            display: none;
        }
        .view-mode {
            display: block;
        }
        .edit-mode .recipe-header h1 {
            font-size: 2rem;
            margin-bottom: 20px;
        }
        .edit-mode input, .edit-mode textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .edit-mode textarea {
            min-height: 100px;
            resize: vertical;
        }
        .nutrition-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .nutrition-input {
            display: flex;
            flex-direction: column;
        }
        .nutrition-input label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        .nutrition-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .timestamp-info {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        .timestamp-info span {
            margin: 0 15px;
        }
        .recipe-timestamps {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #666;
        }
        .tag-input-wrapper {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        #tagInput {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
        }
        .cook-tracking {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .cook-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        .cook-stat {
            text-align: center;
        }
        .cook-stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .cook-stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .mark-cooked-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .mark-cooked-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        .mark-cooked-btn:active {
            transform: translateY(0);
        }
        .cook-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            display: none;
        }
        .cook-success {
            background: rgba(40, 167, 69, 0.2);
            color: #d4edda;
        }
        .reset-cooked-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
            margin-left: 10px;
        }
        .reset-cooked-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        .reset-cooked-btn:active {
            transform: translateY(0);
        }
        .reset-cooked-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .sticky-mobile-header {
            display: none;
        }
        @media (max-width: 700px) {
            body { padding: 0; }
            .container { margin: 0; border-radius: 0; box-shadow: none; }
            .recipe-header, .recipe-body { padding: 0 0 0 0; }
            .recipe-image { height: 220px; }
            .sticky-mobile-header {
                display: flex;
                flex-direction: column;
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                transition: box-shadow 0.2s, min-height 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            }
            .sticky-mobile-header.collapsed {
                flex-direction: row;
                align-items: center;
                min-height: 56px;
                box-shadow: 0 2px 12px rgba(0,0,0,0.12);
            }
            .sticky-mobile-header .mobile-header-image {
                width: 100%;
                height: 160px;
                object-fit: cover;
                border-radius: 0;
                transition: width 0.2s, height 0.2s;
            }
            .sticky-mobile-header.collapsed .mobile-header-image {
                width: 48px;
                height: 48px;
                margin: 4px 10px 4px 8px;
                border-radius: 8px;
            }
            .sticky-mobile-header .mobile-header-content {
                padding: 16px;
                text-align: left;
            }
            .sticky-mobile-header.collapsed .mobile-header-content {
                padding: 0 8px;
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .sticky-mobile-header .mobile-header-title {
                font-size: 1.5rem;
                font-weight: 700;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .sticky-mobile-header.collapsed .mobile-header-title {
                font-size: 1.1rem;
                margin-bottom: 0;
            }
            .sticky-mobile-header .mobile-nutrition-bar {
                display: flex;
                gap: 10px;
                margin-top: 8px;
                flex-wrap: wrap;
            }
            .sticky-mobile-header.collapsed .mobile-nutrition-bar {
                margin-top: 0;
                gap: 6px;
            }
            .mobile-nutrition-badge {
                background: #f0f0f0;
                color: #333;
                border-radius: 6px;
                padding: 2px 8px;
                font-size: 0.95em;
                font-weight: 500;
            }
            /* Hide original header and body on mobile */
            .recipe-header, .nutrition-facts, .recipe-body { display: none; }
            /* Tabs */
            .mobile-tabs {
                display: flex;
                border-bottom: 2px solid #eee;
                background: #fafbfc;
                position: sticky;
                top: 160px;
                z-index: 99;
            }
            .sticky-mobile-header.collapsed + .mobile-tabs {
                top: 56px;
            }
            .mobile-tab {
                flex: 1;
                text-align: center;
                padding: 14px 0;
                font-size: 1.1rem;
                font-weight: 600;
                background: none;
                border: none;
                border-bottom: 3px solid transparent;
                cursor: pointer;
                transition: border-color 0.2s, background 0.2s;
            }
            .mobile-tab.active {
                border-bottom: 3px solid #667eea;
                background: #f6f8fc;
                color: #4b2997;
            }
            .mobile-tab-panel {
                padding: 20px 16px 32px 16px;
            }
            .mobile-section-title {
                font-size: 1.2rem;
                font-weight: 600;
                margin-bottom: 16px;
                padding-bottom: 8px;
                border-bottom: 2px solid #f0f0f0;
            }
            .ingredients-list li, .steps-list li {
                font-size: 1.05rem;
                padding: 10px 0;
                border-bottom: 1px solid #f0f0f0;
            }
            .steps-list li { display: flex; }
            .step-number { font-weight: 600; margin-right: 10px; color: #667eea; }
            .cook-tracking {
                margin: 16px 0 0 0;
                padding: 12px 8px;
                border-radius: 10px;
                font-size: 1rem;
                background: #f8f9fa;
                color: #333;
                box-shadow: none;
            }
            .cook-stats {
                gap: 16px;
                margin-bottom: 8px;
            }
            .cook-stat-value {
                font-size: 1.2rem;
                margin-bottom: 2px;
            }
            .cook-stat-label {
                font-size: 0.85rem;
            }
            .mark-cooked-btn, .reset-cooked-btn {
                font-size: 1rem;
                padding: 10px 18px;
                border-radius: 18px;
            }
            .cook-message {
                font-size: 0.95rem;
                margin-top: 8px;
                padding: 6px;
            }
            /* Kitchen Mode button */
            .kitchen-mode-btn {
                margin-top: 10px;
                margin-bottom: 0;
                padding: 10px 18px;
                border-radius: 18px;
                font-size: 1rem;
                font-weight: 600;
                background: #ffb347;
                color: #333;
                border: none;
                cursor: pointer;
                transition: background 0.2s;
            }
            .kitchen-mode-btn.active {
                background: #ff6b6b;
                color: white;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-link">← All Recipes</a>
    <button id="editBtn" class="edit-btn">✏️ Edit</button>
    <button id="saveBtn" class="save-btn" style="display: none;">💾 Save</button>
    <button id="cancelBtn" class="cancel-btn" style="display: none;">❌ Cancel</button>
    
    <div id="message" class="message"></div>

    <!-- Sticky Mobile Header (only visible on mobile) -->
    <div class="sticky-mobile-header" id="stickyMobileHeader">
        <img src="{{ recipe.image_url or 'https://placehold.co/800x400?text=No+Image' }}" alt="Recipe Image" class="mobile-header-image" id="mobileHeaderImage">
        <div class="mobile-header-content">
            <div class="mobile-header-title">{{ recipe.title }}</div>
            <div class="mobile-nutrition-bar">
                {% if recipe.servings %}<span class="mobile-nutrition-badge">🍽️ {{ recipe.servings }}</span>{% endif %}
                {% if recipe.calories %}<span class="mobile-nutrition-badge">🔥 {{ recipe.calories }}</span>{% endif %}
                {% if recipe.protein %}<span class="mobile-nutrition-badge">💪 {{ recipe.protein }}</span>{% endif %}
                {% if recipe.fat %}<span class="mobile-nutrition-badge">🥑 {{ recipe.fat }}</span>{% endif %}
                {% if recipe.carbs %}<span class="mobile-nutrition-badge">🌾 {{ recipe.carbs }}</span>{% endif %}
                <span class="mobile-nutrition-badge" id="mobileCookCount">🍳 {{ recipe.cook_count or 0 }}x</span>
            </div>
            <button class="kitchen-mode-btn" id="kitchenModeBtn" type="button">Enable Kitchen Mode</button>
        </div>
    </div>
    <!-- Mobile Tabs -->
    <div class="mobile-tabs" id="mobileTabs" style="display:none;">
        <button class="mobile-tab active" id="tabIngredients">Ingredients</button>
        <button class="mobile-tab" id="tabInstructions">Instructions</button>
    </div>
    <div class="mobile-tab-panel" id="panelIngredients" style="display:none;">
        <div class="mobile-section-title">Ingredients</div>
        <ul class="ingredients-list">
            {% for ingredient in recipe.ingredients %}
                <li>{{ ingredient }}</li>
            {% endfor %}
        </ul>
    </div>
    <div class="mobile-tab-panel" id="panelInstructions" style="display:none;">
        <div class="mobile-section-title">Instructions</div>
        <ol class="steps-list">
            {% for step in recipe.steps %}
                <li><span class="step-number">{{ loop.index }}.</span>{{ step }}</li>
            {% endfor %}
        </ol>
    </div>

    <div class="container">
        <!-- View Mode -->
        <div id="viewMode" class="view-mode">
            <img id="recipeImage" src="{{ recipe.image_url or 'https://placehold.co/800x400?text=No+Image' }}" alt="Recipe Image" class="recipe-image">
            <div class="recipe-header">
                <h1>{{ recipe.title }}</h1>
                <p>{{ recipe.description }}</p>
                <div class="nutrition-facts">
                    {% if recipe.servings %}
                    <div class="fact">
                        <div class="fact-value">{{ recipe.servings }}</div>
                        <div class="fact-label">Servings</div>
                    </div>
                    {% endif %}
                    {% if recipe.calories %}
                    <div class="fact">
                        <div class="fact-value">{{ recipe.calories }}</div>
                        <div class="fact-label">Calories</div>
                    </div>
                    {% endif %}
                    {% if recipe.protein %}
                    <div class="fact">
                        <div class="fact-value">{{ recipe.protein }}</div>
                        <div class="fact-label">Protein</div>
                    </div>
                    {% endif %}
                    {% if recipe.fat %}
                    <div class="fact">
                        <div class="fact-value">{{ recipe.fat }}</div>
                        <div class="fact-label">Fat</div>
                    </div>
                    {% endif %}
                    {% if recipe.carbs %}
                    <div class="fact">
                        <div class="fact-value">{{ recipe.carbs }}</div>
                        <div class="fact-label">Carbs</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="recipe-body">
                <div>
                    <h2 class="section-title">Ingredients</h2>
                    <ul class="ingredients-list">
                        {% for ingredient in recipe.ingredients %}
                            <li>{{ ingredient }}</li>
                        {% endfor %}
                    </ul>
                </div>
                <div>
                    <h2 class="section-title">Instructions</h2>
                    <ol class="steps-list">
                        {% for step in recipe.steps %}
                            <li><span class="step-number">{{ loop.index }}.</span>{{ step }}</li>
                        {% endfor %}
                    </ol>
                </div>
            </div>
            
            <!-- Cook Tracking Section -->
            <div class="cook-tracking">
                <div class="cook-stats">
                    <div class="cook-stat">
                        <div class="cook-stat-value" id="cookCount">{{ recipe.cook_count or 0 }}</div>
                        <div class="cook-stat-label">Times Cooked</div>
                    </div>
                    <div class="cook-stat">
                        <div class="cook-stat-value" id="lastCookedDate">
                            {% if recipe.last_cooked_date %}
                                {{ recipe.last_cooked_date[:10] if recipe.last_cooked_date else 'Never' }}
                            {% else %}
                                Never
                            {% endif %}
                        </div>
                        <div class="cook-stat-label">Last Cooked</div>
                    </div>
                </div>
                <button id="markCookedBtn" class="mark-cooked-btn">🍳 Mark as Cooked</button>
                <button id="resetCookedBtn" class="reset-cooked-btn" style="display: none;">🔄 Reset Count</button>
                <div id="cookMessage" class="cook-message cook-success"></div>
            </div>
        </div>
        
        <div class="timestamp-info">
            {% if recipe.created_at %}
            <span> Created: {{ recipe.created_at[:10] if recipe.created_at else 'Unknown' }}</span>
            {% endif %}
            {% if recipe.updated_at %}
            <span>🔄 Updated: {{ recipe.updated_at[:10] if recipe.updated_at else 'Unknown' }}</span>
            {% endif %}
        </div>

        <p class="recipe-timestamps">
            <em>Created: <span id="createdAt"></span> | Last Updated: <span id="updatedAt"></span></em>
        </p>

        <!-- Edit Mode -->
        <div id="editMode" class="edit-mode">
            <img id="recipeImage" src="{{ recipe.image_url or 'https://placehold.co/800x400?text=No+Image' }}" alt="Recipe Image" class="recipe-image">
            <div class="recipe-header">
                <input type="text" id="editTitle" value="{{ recipe.title }}" placeholder="Recipe Title">
                <input type="text" id="editDescription" value="{{ recipe.description }}" placeholder="Recipe Description">
                <input type="text" id="editImageUrl" value="{{ recipe.image_url }}" placeholder="Image URL">
                
                <div class="nutrition-inputs">
                    <div class="nutrition-input">
                        <label for="editServings">Servings</label>
                        <input type="text" id="editServings" value="{{ recipe.servings or '' }}" placeholder="e.g., 4">
                    </div>
                    <div class="nutrition-input">
                        <label for="editCalories">Calories</label>
                        <input type="text" id="editCalories" value="{{ recipe.calories or '' }}" placeholder="e.g., 550">
                    </div>
                    <div class="nutrition-input">
                        <label for="editProtein">Protein</label>
                        <input type="text" id="editProtein" value="{{ recipe.protein or '' }}" placeholder="e.g., 30g">
                    </div>
                    <div class="nutrition-input">
                        <label for="editFat">Fat</label>
                        <input type="text" id="editFat" value="{{ recipe.fat or '' }}" placeholder="e.g., 20g">
                    </div>
                    <div class="nutrition-input">
                        <label for="editCarbs">Carbs</label>
                        <input type="text" id="editCarbs" value="{{ recipe.carbs or '' }}" placeholder="e.g., 50g">
                    </div>
                </div>
            </div>
            <div class="recipe-body">
                <div>
                    <h2 class="section-title">Ingredients</h2>
                    <textarea id="editIngredients" placeholder="Enter ingredients, one per line...">{{ recipe.ingredients | join('\n') }}</textarea>
                </div>
                <div>
                    <h2 class="section-title">Instructions</h2>
                    <textarea id="editSteps" placeholder="Enter instructions, one per line...">{{ recipe.steps | join('\n') }}</textarea>
                </div>
            </div>
            <div class="recipe-body" style="grid-template-columns: 1fr;">
                <div>
                    <h2 class="section-title">📄 Raw Extracted Text</h2>
                    <textarea id="editRawText" placeholder="Raw text from Instagram post...">{{ recipe.raw_text or '' }}</textarea>
                </div>
            </div>
            
            <!-- Tag Section for Edit Mode -->
            <div id="tagSection" class="form-section">
                <label for="tagInput">Tags</label>
                <div class="tags-container" id="tagsContainer">
                    <!-- Tags will be dynamically inserted here -->
                </div>
                <div class="tag-input-wrapper">
                    <input type="text" id="tagInput" list="tagSuggestions" placeholder="Add a tag...">
                    <datalist id="tagSuggestions"></datalist>
                    <button id="addTagBtn" class="btn btn-sm btn-secondary">Add Tag</button>
                </div>
            </div>
        </div>
        
        <div class="timestamp-info" id="editTimestampInfo" style="display: none;">
            {% if recipe.created_at %}
            <span>📅 Created: {{ recipe.created_at[:10] if recipe.created_at else 'Unknown' }}</span>
            {% endif %}
            {% if recipe.updated_at %}
            <span>🔄 Updated: {{ recipe.updated_at[:10] if recipe.updated_at else 'Unknown' }}</span>
            {% endif %}
        </div>
    </div>

    <script>
        // --- Image Proxy Function (Global) ---
        function getProxiedImageUrl(imageUrl) {
            if (!imageUrl) return 'https://placehold.co/800x400?text=No+Image';
            
            // Check if it's an Instagram CDN URL that needs special handling
            if (imageUrl.includes('scontent') && imageUrl.includes('cdninstagram.com')) {
                // For Instagram images, we'll use a placeholder since they often don't work on mobile
                return 'https://placehold.co/800x400?text=Instagram+Image';
            }
            
            // Return original URL for other images (NYTimes, etc.)
            return imageUrl;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const messageDiv = document.getElementById('message');
            const recipeId = {{ recipe.id }};
            let currentTags = [];
            let allTags = [];

            // --- DOM Elements ---
            const viewMode = document.getElementById('viewMode');
            const editMode = document.getElementById('editMode');
            const tagSection = document.getElementById('tagSection');

            function setEditMode(isEditing) {
                viewMode.style.display = isEditing ? 'none' : 'block';
                editMode.style.display = isEditing ? 'block' : 'none';
                tagSection.style.display = isEditing ? 'block' : 'none';
                
                // Show/hide the action buttons
                editBtn.style.display = isEditing ? 'none' : 'inline-block';
                saveBtn.style.display = isEditing ? 'inline-block' : 'none';
                cancelBtn.style.display = isEditing ? 'inline-block' : 'none';
            }

            async function saveRecipe() {
                const recipeData = getFieldValues();

                if (!recipeData.title) {
                    showMessage('Recipe title is required.', 'error');
                    return;
                }

                try {
                    const response = await fetch(`/update_recipe/${recipeId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipe: recipeData })
                    });
                    const result = await response.json();

                    if (result.success) {
                        // Using reload is a simple way to see changes without complex state management
                        window.location.reload();
                    } else {
                        showMessage(result.error || 'Failed to update recipe.', 'error');
                    }
                } catch (error) {
                    console.error('Failed to update recipe:', error);
                    showMessage('An error occurred while saving the recipe.', 'error');
                }
            }

            async function fetchTagsForAutocomplete() {
                try {
                    const response = await fetch('/tags');
                    const data = await response.json();
                    allTags = data.tags;
                    const datalist = document.getElementById('tagSuggestions');
                    datalist.innerHTML = '';
                    allTags.forEach(tag => {
                        const option = document.createElement('option');
                        option.value = tag;
                        datalist.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to fetch tags:', error);
                }
            }

            function renderTags() {
                const tagsContainer = document.getElementById('tagsContainer');
                tagsContainer.innerHTML = '';
                currentTags.forEach(tag => {
                    const tagEl = document.createElement('div');
                    tagEl.className = 'tag-item';
                    tagEl.textContent = tag;
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-tag-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => removeTag(tag);
                    tagEl.appendChild(removeBtn);
                    tagsContainer.appendChild(tagEl);
                });
            }

            function addTag() {
                const tagInput = document.getElementById('tagInput');
                const tag = tagInput.value.trim().toLowerCase();
                if (tag && !currentTags.includes(tag)) {
                    currentTags.push(tag);
                    renderTags();
                }
                tagInput.value = '';
            }

            function removeTag(tagToRemove) {
                currentTags = currentTags.filter(tag => tag !== tagToRemove);
                renderTags();
            }

            function getFieldValues() {
                return {
                    title: document.getElementById('editTitle').value,
                    description: document.getElementById('editDescription').value,
                    image_url: document.getElementById('editImageUrl').value,
                    ingredients: document.getElementById('editIngredients').value.split('\n').filter(line => line.trim() !== ''),
                    steps: document.getElementById('editSteps').value.split('\n').filter(line => line.trim() !== ''),
                    servings: document.getElementById('editServings').value,
                    calories: document.getElementById('editCalories').value,
                    protein: document.getElementById('editProtein').value,
                    fat: document.getElementById('editFat').value,
                    carbs: document.getElementById('editCarbs').value,
                    raw_text: document.getElementById('editRawText').value,
                    tags: currentTags
                };
            }

            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }

            async function markAsCooked() {
                const markCookedBtn = document.getElementById('markCookedBtn');
                const cookMessage = document.getElementById('cookMessage');
                
                // Disable button during request
                markCookedBtn.disabled = true;
                markCookedBtn.textContent = '🔄 Marking...';
                
                try {
                    const response = await fetch(`/mark_cooked/${recipeId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();

                    if (result.success) {
                        // Update the display
                        document.getElementById('cookCount').textContent = result.cook_count;
                        document.getElementById('lastCookedDate').textContent = result.last_cooked_date ? result.last_cooked_date.substring(0, 10) : 'Never';
                        
                        // Show success message
                        cookMessage.textContent = result.message;
                        cookMessage.style.display = 'block';
                        setTimeout(() => {
                            cookMessage.style.display = 'none';
                        }, 3000);
                        
                        // Show reset button if cook count > 0
                        updateResetButtonVisibility(result.cook_count > 0);
                    } else {
                        showMessage(result.error || 'Failed to mark recipe as cooked.', 'error');
                    }
                } catch (error) {
                    console.error('Failed to mark recipe as cooked:', error);
                    showMessage('An error occurred while marking the recipe as cooked.', 'error');
                } finally {
                    // Re-enable button
                    markCookedBtn.disabled = false;
                    markCookedBtn.textContent = '🍳 Mark as Cooked';
                }
            }

            async function resetCookCount() {
                const resetCookedBtn = document.getElementById('resetCookedBtn');
                const cookMessage = document.getElementById('cookMessage');
                
                // Confirm with user
                if (!confirm('Are you sure you want to reset the cook count and history for this recipe?')) {
                    return;
                }
                
                // Disable button during request
                resetCookedBtn.disabled = true;
                resetCookedBtn.textContent = '🔄 Resetting...';
                
                try {
                    const response = await fetch(`/reset_cook_count/${recipeId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();

                    if (result.success) {
                        // Update the display
                        document.getElementById('cookCount').textContent = result.cook_count;
                        document.getElementById('lastCookedDate').textContent = 'Never';
                        
                        // Show success message
                        cookMessage.textContent = result.message;
                        cookMessage.style.display = 'block';
                        setTimeout(() => {
                            cookMessage.style.display = 'none';
                        }, 3000);
                        
                        // Hide reset button since count is now 0
                        updateResetButtonVisibility(false);
                    } else {
                        showMessage(result.error || 'Failed to reset cook count.', 'error');
                    }
                } catch (error) {
                    console.error('Failed to reset cook count:', error);
                    showMessage('An error occurred while resetting the cook count.', 'error');
                } finally {
                    // Re-enable button
                    resetCookedBtn.disabled = false;
                    resetCookedBtn.textContent = '🔄 Reset Count';
                }
            }

            function updateResetButtonVisibility(show) {
                const resetCookedBtn = document.getElementById('resetCookedBtn');
                resetCookedBtn.style.display = show ? 'inline-block' : 'none';
            }

            // --- Event Listeners ---
            editBtn.addEventListener('click', () => setEditMode(true));
            cancelBtn.addEventListener('click', () => setEditMode(false));
            saveBtn.addEventListener('click', saveRecipe);
            document.getElementById('addTagBtn').addEventListener('click', addTag);
            document.getElementById('tagInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });
            document.getElementById('markCookedBtn').addEventListener('click', markAsCooked);
            document.getElementById('resetCookedBtn').addEventListener('click', resetCookCount);

            // --- Initial Page Setup ---
            setEditMode(false);
            fetchTagsForAutocomplete();
            currentTags = [];
            renderTags();
            
            // Initialize reset button visibility based on current cook count
            const currentCookCount = parseInt(document.getElementById('cookCount').textContent) || 0;
            updateResetButtonVisibility(currentCookCount > 0);
            
            // Set up image proxy for Instagram images
            const recipeImage = document.getElementById('recipeImage');
            if (recipeImage) {
                const originalSrc = recipeImage.src;
                recipeImage.src = getProxiedImageUrl(originalSrc);
            }
        });

        // Mobile sticky header collapse and tabbed interface
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth > 700) return;
            // Show mobile tabs and panels
            document.getElementById('mobileTabs').style.display = '';
            document.getElementById('panelIngredients').style.display = '';
            document.getElementById('panelInstructions').style.display = 'none';

            // Tab switching
            const tabIngredients = document.getElementById('tabIngredients');
            const tabInstructions = document.getElementById('tabInstructions');
            const panelIngredients = document.getElementById('panelIngredients');
            const panelInstructions = document.getElementById('panelInstructions');
            tabIngredients.addEventListener('click', function() {
                tabIngredients.classList.add('active');
                tabInstructions.classList.remove('active');
                panelIngredients.style.display = '';
                panelInstructions.style.display = 'none';
            });
            tabInstructions.addEventListener('click', function() {
                tabInstructions.classList.add('active');
                tabIngredients.classList.remove('active');
                panelInstructions.style.display = '';
                panelIngredients.style.display = 'none';
            });

            // Sticky header collapse on scroll
            const stickyHeader = document.getElementById('stickyMobileHeader');
            let lastScrollY = window.scrollY;
            window.addEventListener('scroll', function() {
                if (window.scrollY > 80) {
                    stickyHeader.classList.add('collapsed');
                } else {
                    stickyHeader.classList.remove('collapsed');
                }
                lastScrollY = window.scrollY;
            });

            // Kitchen Mode (Wake Lock API)
            let wakeLock = null;
            const kitchenModeBtn = document.getElementById('kitchenModeBtn');
            let kitchenModeActive = false;
            async function enableKitchenMode() {
                if ('wakeLock' in navigator) {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');
                        kitchenModeActive = true;
                        kitchenModeBtn.textContent = 'Disable Kitchen Mode';
                        kitchenModeBtn.classList.add('active');
                    } catch (err) {
                        alert('Could not enable Kitchen Mode: ' + err.message);
                    }
                } else {
                    alert('Kitchen Mode is not supported on this device/browser.');
                }
            }
            async function disableKitchenMode() {
                if (wakeLock) {
                    try {
                        await wakeLock.release();
                    } catch (err) {}
                    wakeLock = null;
                }
                kitchenModeActive = false;
                kitchenModeBtn.textContent = 'Enable Kitchen Mode';
                kitchenModeBtn.classList.remove('active');
            }
            kitchenModeBtn.addEventListener('click', function() {
                if (kitchenModeActive) {
                    disableKitchenMode();
                } else {
                    enableKitchenMode();
                }
            });
            // Release wake lock on navigation away
            window.addEventListener('beforeunload', disableKitchenMode);
            // Also release on visibility change (e.g. user switches tabs)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    disableKitchenMode();
                }
            });
        });
    </script>
</body>
</html>